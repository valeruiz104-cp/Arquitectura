<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Constructor de Datagrama IPv4</title>

  <style>
    body { font-family: 'Arial'; padding: 10px; background: #ffeef6; }
    h1 { text-align: center; font-size: 1.6rem; color: #d46aa5; }
    .section { background: #ffffff; padding: 15px; margin-bottom: 18px; border-radius: 15px;
               box-shadow: 0 3px 8px rgba(212, 106, 165, 0.20); border: 2px solid #f8cbe5; }
    label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.95rem; color: #c2548e; }
    input, select, textarea {
        width: 100%; padding: 9px; font-size: 0.9rem; margin-top: 5px;
        border-radius: 8px; border: 1.5px solid #f3a9d6; background: #fff7fb;
    }
    input:focus, select:focus, textarea:focus {
        outline: none; border-color: #d46aa5; background: #ffe6f3;
    }
    button {
        width: 100%; padding: 12px; border-radius: 10px; font-size: 1rem; border: none;
        background: #ffbde0; color: #7a2f57; font-weight: bold;
        box-shadow: 0 2px 6px rgba(200, 70, 140, 0.3);
    }
    button:hover { background: #ff9fd2; }
    pre {
        background: #4b0037; color: #ffcef0; padding: 15px; border-radius: 10px;
        font-size: 0.78rem; overflow-x: auto; box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    }
  </style>
</head>

<body>
  <h1>Encabezado del Datagrama IPv4</h1>

  <div class="section">
    <label>Valeria Rodriguez Ruiz</label>
  </div>

  <div class="section">
    <label>Versión (fijo en 4):</label>
    <input id="version" value="4" disabled />

    <label>Longitud del encabezado (IHL) [5 - 15]:</label>
    <select id="ihl"></select>

    <label>Tipo de Servicio (TOS):</label>
    <select id="tos">
      <option value="00">Routine</option>
      <option value="10">Priority</option>
      <option value="20">Immediate</option>
      <option value="30">Flash</option>
      <option value="40">Flash Override</option>
      <option value="50">CRITIC/ECP</option>
      <option value="60">Internetwork Control</option>
      <option value="70">Network Control</option>
    </select>

    <label>Identificación (16 bits, solo números 0-65535):</label>
    <input id="identificacion" inputmode="numeric" placeholder="" />

    <label>Flags:</label>
    <input id="flags" placeholder="0-7" />

    <label>Desplazamiento de fragmento:</label>
    <input id="frag" placeholder="Hexadecimal" />

    <label>TTL (Tiempo de vida):</label>
    <input id="ttl" placeholder="0-255" />

    <label>Protocolo:</label>
    <select id="protocolo">
      <option value="06">TCP</option>
      <option value="11">UDP</option>
      <option value="01">ICMP</option>
      <option value="02">IGMP</option>
    </select>

    <label>Checksum:</label>
    <input id="checksum" placeholder="Hexadecimal" />

    <label>IP Fuente:</label>
    <input id="src" placeholder="192.168.1.1" inputmode="numeric" />

    <label>IP Destino:</label>
    <input id="dst" placeholder="192.168.1.2" inputmode="numeric" />

    <label>Opciones (hex):</label>
    <textarea id="opciones" placeholder="Opciones en hex"></textarea>

    <label>Datos (caracteres legibles):</label>
    <textarea id="datos" placeholder="Mensaje"></textarea>
  </div>

  <button onclick="generar()">Generar Datagrama</button>

  <h2>Datagrama en Hexadecimal:</h2>
  <pre id="salida"></pre>

<script>
    window.onload = () => {
        const ihl = document.getElementById("ihl");
        for (let i = 5; i <= 15; i++) {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = i;
            ihl.appendChild(opt);
        }
    };

    // Validaciones
    function soloNumeros(campo) {
        campo.addEventListener("input", () => {
            campo.value = campo.value.replace(/[^0-9]/g, "");
        });
    }

    function soloIP(campo) {
        campo.addEventListener("input", () => {
            let v = campo.value;
            v = v.replace(/[^0-9.]/g, "");
            v = v.replace(/\.{2,}/g, ".");
            if (v.startsWith(".")) v = v.slice(1);
            let partes = v.split(".");
            if (partes.length > 4) {
                v = partes.slice(0, 4).join(".");
            }
            campo.value = v;
        });
    }

    // Identificación: solo números y máximo 16 bits
    const idCampo = document.getElementById("identificacion");
    idCampo.addEventListener("input", () => {
        idCampo.value = idCampo.value.replace(/[^0-9]/g, "");
        let valor = parseInt(idCampo.value, 10);
        if (isNaN(valor)) valor = 0;
        if (valor > 65535) valor = 65535;
        idCampo.value = valor;
    });

    // TTL: solo números
    soloNumeros(document.getElementById("ttl"));

    // Flags 0-7
    document.getElementById("flags").addEventListener("input", () => {
        let v = document.getElementById("flags").value.replace(/[^0-9]/g, "");
        if (v > 7) v = "7";
        document.getElementById("flags").value = v;
    });

    // IP
    soloIP(document.getElementById("src"));
    soloIP(document.getElementById("dst"));

    // Desplazamiento de fragmento: solo hex, máximo 16 bits (4 hex dígitos)
    const fragCampo = document.getElementById("frag");
    fragCampo.addEventListener("input", () => {
        fragCampo.value = fragCampo.value.toUpperCase().replace(/[^0-9A-F]/g, "");
        if (fragCampo.value.length > 4) fragCampo.value = fragCampo.value.slice(0, 4);
    });

    // Checksum: solo hex, máximo 13 bits (0x1FFF)
    const checksumCampo = document.getElementById("checksum");
    checksumCampo.addEventListener("input", () => {
        checksumCampo.value = checksumCampo.value.toUpperCase().replace(/[^0-9A-F]/g, "");
        let valor = parseInt(checksumCampo.value, 16);
        if (isNaN(valor)) valor = 0;
        if (valor > 0x1FFF) valor = 0x1FFF;
        checksumCampo.value = valor.toString(16).toUpperCase();
    });

    // Opciones hex
    const opcionesCampo = document.getElementById("opciones");
    opcionesCampo.addEventListener("input", () => {
        opcionesCampo.value = opcionesCampo.value.toUpperCase().replace(/[^0-9A-F]/g, "");
    });

    // Funciones de conversión
    function toHex(num, size = 2) {
        num = parseInt(num);
        return num.toString(16).padStart(size, "0");
    }

    function ipToHex(ip) {
        const parts = ip.split(".");
        if (parts.length !== 4) throw "IP inválida";
        return parts.map(p => {
            if (p < 0 || p > 255) throw "IP fuera de rango";
            return toHex(p);
        }).join("");
    }

    // Generar datagrama
    function generar() {
        try {
            const ihl = parseInt(document.getElementById("ihl").value);
            const tos = document.getElementById("tos").value;
            const opciones = document.getElementById("opciones").value.replace(/\s+/g, "");
            const datos = document.getElementById("datos").value;

            const headerLength = ihl * 4;
            const optionsLength = headerLength - 20;

            if (opciones.length !== optionsLength * 2) {
                alert(`Debe haber exactamente ${optionsLength} bytes de opciones.`);
                return;
            }

            const datosHex = Array.from(datos).map(c => c.charCodeAt(0).toString(16).padStart(2, "0")).join("");

            const totalLength = headerLength + datos.length;

            const id = parseInt(document.getElementById("identificacion").value || "1");
            const flags = parseInt(document.getElementById("flags").value || "2");
            if (flags < 0 || flags > 7) throw "Las flags deben ser un valor entre 0 y 7";

            const frag = document.getElementById("frag").value || "0";
            const ttl = document.getElementById("ttl").value || "64";
            const protocolo = document.getElementById("protocolo").value;
            const checksum = document.getElementById("checksum").value || "0";

            const src = ipToHex(document.getElementById("src").value);
            const dst = ipToHex(document.getElementById("dst").value);

            const datagrama =
                toHex((4 << 4) + ihl) +
                tos +
                toHex(totalLength, 4) +
                toHex(id, 4) + // 16 bits
                toHex((flags << 13) + parseInt(frag, 16), 4) +
                toHex(ttl) +
                protocolo +
                toHex(parseInt(checksum, 16), 4) +
                src +
                dst +
                opciones +
                datosHex;

            document.getElementById("salida").textContent = datagrama.toUpperCase();

        } catch (err) {
            alert("Error: " + err);
        }
    }
</script>

</body>
</html>
